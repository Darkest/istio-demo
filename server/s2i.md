# Source-to-image (s2i)

s2i прдставляет собой инстурмент автоматизированной сборки приложений на
базе различный языков программирования. Для использования инструмента
требуется:
- docker образ сборщика
- исходный код приложения, котрое необходимо собрать

Репозиторий RedHat предоставялет доступ к образам-сборщикам для многих
популярных языков программирования, далее мы будем рассматривать пример
сборки приожения на базе языка Go Для сборки приложения на языке Go нам
потребуется следующий образ:
`registry.redhat.io/devtools/go-toolset-rhel7:1.13.4`  
Первая часть версии `1.13` говорит о версии языка go используемого в
данном контейнере для сборки

Попробуем собрать приложение "Hello, World" доступное в репозитории
`https://github.com/sclorg/golang-ex.git`, для этого выполним в консоли
следующую команду `s2i build https://github.com/sclorg/golang-ex.git
registry.redhat.io/devtools/go-toolset-rhel7 hello-go`, где

- s2i - название утилиты source-to-image
- build - команда означающая сборку образа с приложением
- https://github.com/sclorg/golang-ex.git - адрес репозитория с кодом
  приложения
- registry.redhat.io/devtools/go-toolset-rhel7 имя образа в котором
  будет происходить сборка(версия образа опущена - будет использоваться
  версия с тэгом latest)
- hello-go - имя собранного образа с приложением

При выволнении команды может возникнуть ошибка вида `pulling image error
: Error response from daemon: Get
https://registry.redhat.io/v2/devtools/go-toolset-rhel7/manifests/latest:
unauthorized: Please login to the Red Hat Registry using your Customer
Portal credentials. Further instructions can be found here:
https://access.redhat.com/RegistryAuthentication` На данный момент в
качестве решения этой проблемы предлагается вручную загрузить образ
сборщика командой `docker pull
registry.redhat.io/devtools/go-toolset-rhel7`, предварительно
авторизовавшись в репозитории RedHat командой `docker login
registry.redhat.io`

После успешного выполнения сборки в локальном docker репозитории должен
появится образ с именем `hello-go`

## Как работает Source-to-Image

Для динамических языков, наподобие Ruby, окрежение времени сборки и
времени запуска обычно идентичны. Начиная с образа сборщика, в котором
описывается окружение с Ruby, Bundler, Rake, Apache, GCC, и другими
пакетами, необходимыми для установки и запуска прилоежения на Ruby,
source-to-image выполняет следующие действия:

- Запускает контейнер из образа сборщика скопировав туда исходный код
  приложения для сборки (в определенную директорию)
- Внутри контейнера исходный код трансформируется в подходящую для
  запуска конфигурацию, в данном случае путем установки зависимостей с
  помощью Bundler и переноса исходного кода туда где Apache будет искать
  файл config.ru
- Делает коммит получившегося контейнера и устанвливает точку запуска
  (ENTRYPOINT) на срипт запуска Apache

Для компилируемых языков, таких как C, C++, Go, или Java, в которых вес
зависимостей необходимых для компиляции может сильно превосходить вес
зависимостей необходимых для запуска, s2i создает отдельных контейнер
для запуска приложения, в который помещаются только завивимости
необходимые для запуска.

