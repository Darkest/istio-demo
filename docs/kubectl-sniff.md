# Сбор и просмотр TCP трафика внутри Open Shift кластера

В случаях, когда логи приложений, envoy, и других компонентов Service Mesh не позволяют диагностировать проблему, существует возможность просмотреть весь низкоуровненвый трафик между всеми комппонентами.
Для этого можно воспользоваться связкой из следующих инструментов:
- **Kubectl** для доступа к кластеру опеншифта
- плагин **sniff** для настройки перехватат трафика
- Wireshark для просмотра перехваченного трафика

1. Устанавливаем kubectl https://kubernetes.io/ru/docs/tasks/tools/install-kubectl/   
2. Устанавливаем плагин kubectl-sniff
https://github.com/eldadru/ksniff  
2.1. Скачиваем дистрибутив по [ссылке](https://github.com/eldadru/ksniff/releases/download/v1.5.0/ksniff.zip)    
2.2. Распаковываем архив в любую директорию, которая содержится в PATH вашей операционной системы  
2.2.1. Для пользователей Windows необходимо переименовть файл kubectl-sniff-windows в kubectl-sniff.exe  
2.3. Проверяем что плагин успешно распознан утилитой kubectl `kubectl plugin list`. В выводе должна содержаться строка наподобие `C:\job\istio-1.4.8\kubectl-sniff.exe`    
3. Устанавливаем дистрибутив [Wireshark](https://www.wireshark.org/download.html)  
3.1. Все опции при установке можно оставить по-умолчанию.  
4. Осуществляем логин в кластер OpenShift `oc login` либо с помощью kubectl  
5. Запускаем процесс перехвата трафика `kubectl sniff <имя пода> -с <имя контейнера> -p -n istio-demo`  
5.1. Подробно почитать про дополнительные ключи запуска плагина sniff для тонкой настройки перехватат трафика можно [здесь](https://github.com/eldadru/ksniff) либо в подсказках самого плагина `kubectl sniff`
6. Если все было настроено согласно инструкции через несколько десятков секунд(10-30) должно открыться приложение Wireshark настроенное на прием перехваченного трафика
7. Для удобства поиска TCP пакетов можно применять фильтры отображения (display filters). Подробнее [тут](https://wiki.wireshark.org/DisplayFilters)